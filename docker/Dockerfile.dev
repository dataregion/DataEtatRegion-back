FROM ghcr.io/astral-sh/uv:0.9.8-python3.13-trixie-slim@sha256:ec7ea3a2dad3a48465b33fe743741e0ab1b2d68b7c5b5b67bb4538fe2be62575 AS builder

WORKDIR /build
# Copie du projet
COPY . .

# Prépare les venv de dev des différentes applications
RUN cd app/ && \
    uv venv && \
    uv pip install .[dev] -r requirements.external.txt && pip install -r requirements.editable.txt --no-deps && \
    cd ..

RUN cd apis/ && \
    uv venv && \
    uv pip install .[dev] -r requirements.external.txt && pip install -r requirements.editable.txt --no-deps && \
    cd ..

RUN cd tests_e2e/ && \
    uv venv && \
    uv pip install .[dev] && \
    cd ..

RUN cd grist-plugins/ && \
    uv venv && \
    uv pip install .[dev] -r requirements.external.txt && pip install -r requirements.editable.txt --no-deps && \
    cd ..

RUN cd services/ && \
    uv venv && \
    SERVICES_IS_TRANSITIVE_DEP=0 uv pip install .[dev] && \
    cd ..

RUN cd models/ && \
    uv venv && \
    uv pip install .[dev] && \
    cd ..

RUN cd gristcli/ && \
    uv venv && \
    uv pip install .[dev] && \
    cd ..

FROM ghcr.io/astral-sh/uv:0.9.8-python3.13-trixie-slim@sha256:ec7ea3a2dad3a48465b33fe743741e0ab1b2d68b7c5b5b67bb4538fe2be62575

WORKDIR /build

COPY --from=builder /build/app/.venv /build/app/.venv
COPY --from=builder /build/apis/.venv /build/apis/.venv
COPY --from=builder /build/grist-plugins/.venv /build/grist-plugins/.venv
COPY --from=builder /build/tests_e2e/.venv /build/tests_e2e/.venv
COPY --from=builder /build/services/.venv /build/services/.venv
COPY --from=builder /build/models/.venv /build/models/.venv
COPY --from=builder /build/gristcli/.venv /build/gristcli/.venv