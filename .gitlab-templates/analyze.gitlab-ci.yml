include:
  - component: $CI_SERVER_FQDN/csm/gitlab-components/docker-build@5.0.5
    inputs:
      image-name: nocode/dev
      image-tag: latest-snapshot
      build-context: ./
      dockerfile-name: ./docker/Dockerfile.dev
      do-login: true
      registry: ${REGISTRY}
      registry-login: ${REGISTRY_USER}
      do-push: true
      enable-debug: true

#####################
# Taches "fourre tout"

"Print pipeline variables for debug":
  stage: ‚ò¢Ô∏è analyze
  rules:
    - when: never # XXX: √† r√©activer au besoin
  script:
    - |
      echo "Commit ref name         : $CI_COMMIT_REF_NAME"
      echo "Pipeline source         : $CI_PIPELINE_SOURCE"
      echo "Gitlab user login       : $GITLAB_USER_LOGIN"
      echo "DO_ANALYZE              : $DO_ANALYZE"
      echo "DO_TEST                 : $DO_TEST"
      echo "DO_BUILD                : $DO_BUILD"
      echo "DO_DOCKERIZE            : $DO_DOCKERIZE"
      echo "DO_INTEG_TESTS          : $DO_INTEG_TESTS"
      echo "DO_LOAD_TESTS:          : $DO_LOAD_TESTS"
      echo "DO_DEPLOY               : $DO_DEPLOY"
      echo "DO_DEPLOY_FOR_INTEG     : $_ENABLE_DEPLOY_FOR_INTEG"
      echo "DO_DEPLOY_FOR_PP_AND_P  : $_ENABLE_DEPLOY_FOR_PP_AND_P"

update-pinned-dependencies:
  stage: ‚ò¢Ô∏è analyze
  image: "ghcr.io/astral-sh/uv:0.10.2-python3.13-trixie-slim@sha256:64d5d762d68eb723d7ae0a27f5bae6a4da39110ad83c9c95f27ecd99237be2ab"
  when: always
  script:
    - |
      apt update && apt install -y git curl jq
      git config user.email "forge@acme.me"
      git config user.name "Forge"

    - |

      for folder in app apis batches grist-plugins; do
        cd $folder/ && ./.build-helper-scripts/update-requirements-external.sh
        cd ..
        git add $folder/requirements.external.txt # Pour supporter le rafraichissement des d√©pendances via suppression du requirements.external.txt
      done

    - |
      

      rc=0
      ./.gitlab-templates/x-commit.sh \
        "$FORGE_PAT"\
        "[FORGE] Mise √† jour des d√©pendances √©pingl√©es." || rc=$?

      if [ $rc -eq 0 ]; then
        echo >&2 "Nouvelle r√©vision avec les d√©pendences pinned, on annule cette pipeline"
        ./.gitlab-templates/x-cancel-pipeline.sh "$FORGE_PAT"
      else
        echo >&2 "Aucune mise √† jour de d√©pendances pinned. On continue"
      fi

# Construit une image avec les venv de devs install√©s
"üê≥ dockerizing nocode/dev image":
  stage: ‚ò¢Ô∏è analyze
  extends: ".dockerize-nocode/dev"
  when: always
  needs:
    - job: update-pinned-dependencies
      optional: true

run-loadtests:
  stage: ‚ò¢Ô∏è analyze
  image: "${REGISTRY}nocode/dev:latest-snapshot"
  before_script:
    - |
      export KEYCLOAK_URL="${E2E_LT_KEYCLOAK_URL}"
      export KEYCLOAK_REALM="${E2E_LT_KEYCLOAK_REALM}"
      export CLIENT_ID="${E2E_LT_CLIENT_ID}"
      export USERNAME="${E2E_LT_USERNAME}"
      export PASSWORD="${E2E_LT_PASSWORD}"
      export API_BASE_URL="${E2E_LT_API_BASE_URL}"
      export MAIL_ENABLED="true"
      export MAIL_HOST="${E2E_LT_MAIL_HOST}"
      export MAIL_PORT="${E2E_LT_MAIL_PORT}"
      export MAIL_LOGIN="${E2E_LT_MAIL_LOGIN}"
      export MAIL_PASSWORD="${E2E_LT_MAIL_PASSWORD}"
      export MAIL_FROM="${E2E_LT_MAIL_FROM}"
      export MAIL_TO="${E2E_LT_MAIL_TO}"
      export NB_USERS=${E2E_LT_NB_USERS:-10}
      export SPAWN_RATE=${E2E_LT_SPAWN_RATE:-2}
      export RUN_TIME_SECONDS=${E2E_LT_RUN_TIME_SECONDS:-60}
  script:
    - env
    - | 
      cd tests_e2e/ && \
      source /build/tests_e2e/.venv/bin/activate && \
      perf-tests --run-time $RUN_TIME_SECONDS --users $NB_USERS --spawn-rate $SPAWN_RATE
  rules:
    - if: '$DO_LOAD_TESTS == "‚úÖ"'
    - if: '$DO_LOAD_TESTS == "‚öôÔ∏è"'
      when: manual
    - when: never
  needs:
    - "üê≥ dockerizing nocode/dev image"

#####################
# Taches d'analyse

.default-analyze: &default-analyze
  stage: ‚ò¢Ô∏è analyze
  image: "${REGISTRY}nocode/dev:latest-snapshot"
  rules:
    - if: '$DO_ANALYZE == "‚úÖ"'
      needs:
        - "üê≥ dockerizing nocode/dev image"
    - if: '$DO_ANALYZE == "‚öôÔ∏è"'
      when: manual
      needs:
        - "üê≥ dockerizing nocode/dev image"
    - when: never

"Analyse pyright":
  <<: *default-analyze
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends libatomic1
    - uv pip install pyright --system
  script: |
    set -euo pipefail
    PWD_VAR="$(pwd)"

    for folder in app apis batches services models grist-plugins gristcli supersetcli tests_e2e; do
      echo >&2 "Analyse pyright pour: $folder"
      cd "$PWD_VAR/$folder/"
      source /build/$folder/.venv/bin/activate
      pyright .
    done

"Analyse d'architecture":
  <<: *default-analyze
  script: |
    set -euo pipefail
    PWD_VAR="$(pwd)"

    for folder in app apis batches; do
      echo >&2 "Analyse d'architecture pour: $folder"
      cd "$PWD_VAR/$folder/"
      source /build/$folder/.venv/bin/activate
      lint-imports --config .importlinter.toml --no-cache --show-timings
    done

"Analyse syntaxique":
  <<: *default-analyze
  before_script:
    - uv pip install ruff --system
  script:
    - ruff format --check app/
    - ruff format --check apis/
    - ruff format --check batches/
    - ruff format --check grist-plugins/
    - ruff format --check services/
    - ruff format --check models/
    - ruff format --check gristcli/
    - ruff format --check supersetcli/
    - ruff format --check tests_e2e/

"Analyse ruff":
  <<: *default-analyze
  before_script:
    - uv pip install ruff --system
  script:
    - ruff check app/
    - ruff check apis/
    - ruff check batches/
    - ruff check grist-plugins/
    - ruff check services/
    - ruff check models/
    - ruff check gristcli/
    - ruff check supersetcli/
    - ruff check tests_e2e/
