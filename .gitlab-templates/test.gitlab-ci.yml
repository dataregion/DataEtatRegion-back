.default-tests: &default-tests
  stage: 🧪 test
  image: ${PYTHON_IMAGE}
  rules:
    - if: '$DO_TEST == "✅"'
    - if: '$DO_TEST == "⚙️"'
      when: manual
    - when: never
  script:
    - unset DOCKER_AUTH_CONFIG # XXX: On ignore la configuration au sein des tests du à une incompatibilité avec testcontainers
    - coverage run -m pytest
    - coverage report
    - coverage xml
  artifacts:
    paths:
      - tests/coverage.xml

run_services_tests:
  <<: *default-tests
  before_script:
    - cd services/
    - env
    - pip install .[dev]

run_app_tests:
  <<: *default-tests
  before_script:
    - cd app/
    - env
    - pip install .[dev] -r requirements.external.txt && pip install -r requirements.editable.txt --no-deps
