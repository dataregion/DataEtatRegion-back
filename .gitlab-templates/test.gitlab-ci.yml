.default-tests: &default-tests
  stage: 🧪 test
  image: "${REGISTRY}nocode/dev:latest-snapshot"
  rules:
    - if: '$DO_TEST == "✅"'
    - if: '$DO_TEST == "⚙️"'
      when: manual
    - when: never
  script:
    - unset DOCKER_AUTH_CONFIG # XXX: On ignore la configuration au sein des tests du à une incompatibilité avec testcontainers
    - coverage run -m pytest
    - coverage report
    - coverage xml
  artifacts:
    paths:
      - tests/coverage.xml
  needs:
    - "🐳 dockerizing nocode/dev image"

run_models_tests:
  <<: *default-tests
  before_script:
    - cd models/
    - env
    - source /build/models/.venv/bin/activate

run_services_tests:
  <<: *default-tests
  before_script:
    - cd services/
    - env
    - source /build/services/.venv/bin/activate

run_apis_tests:
  <<: *default-tests
  before_script:
    - cd apis/
    - env
    - source /build/apis/.venv/bin/activate

run_app_tests:
  <<: *default-tests
  before_script:
    - cd app/
    - env
    - source /build/app/.venv/bin/activate