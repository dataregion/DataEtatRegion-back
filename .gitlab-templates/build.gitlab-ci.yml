include:
  - component: $CI_SERVER_FQDN/csm/gitlab-components/docker-build@4.0.4
    inputs:
      image-name: ${REGISTRY}nocode/data-transform
      image-tag: ${DATA_TRANSFORM_VER}
      build-context: ./
      dockerfile-name: ./app/Dockerfile
      do-login: true
      registry: ${REGISTRY}
      registry-login: ${REGISTRY_USER}
      do-push: true
      enable-debug: true

  - component: $CI_SERVER_FQDN/csm/gitlab-components/docker-build@4.0.4
    inputs:
      image-name: ${REGISTRY}nocode/apis
      image-tag: ${DATA_TRANSFORM_VER}
      build-context: ./
      dockerfile-name: ./apis/Dockerfile
      do-login: true
      registry: ${REGISTRY}
      registry-login: ${REGISTRY_USER}
      do-push: true
      enable-debug: true

  - component: $CI_SERVER_FQDN/csm/gitlab-components/docker-build@4.0.4
    inputs:
      image-name: ${REGISTRY}nocode/grist-plugins
      image-tag: ${DATA_TRANSFORM_VER}
      build-context: ./
      dockerfile-name: ./grist-plugins/Dockerfile
      do-login: true
      registry: ${REGISTRY}
      registry-login: ${REGISTRY_USER}
      do-push: true
      enable-debug: true

  - component: $CI_SERVER_FQDN/csm/gitlab-components/docker-build@4.0.4
    inputs:
      image-name: nocode/data-etat-python-base
      build-context: ./
      dockerfile-name: ./docker/Dockerfile.base
      do-login: false
      do-push: false
      enable-debug: true

.default-dockerize: &default-dockerize
  rules:
    - if: '$DO_DOCKERIZE == "‚úÖ"'
    - if: '$DO_DOCKERIZE == "‚öôÔ∏è"'
      when: manual
    - when: never

"üê≥ dockerizing data-transform":
  <<: *default-dockerize
  extends: ".dockerize-${REGISTRY}nocode/data-transform"
  stage: üê≥ dockerize
  needs: 
    - job: "üê≥ dockerizing base image"
      optional: true

"üê≥ dockerizing apis":
  <<: *default-dockerize
  extends: ".dockerize-${REGISTRY}nocode/apis"
  stage: üê≥ dockerize
  needs: 
    - job: "üê≥ dockerizing base image"
      optional: true

"üê≥ dockerizing grist-plugins-dataEtat":
  <<: *default-dockerize
  extends: ".dockerize-${REGISTRY}nocode/grist-plugins"
  stage: üê≥ dockerize
  needs: 
    - job: "üê≥ dockerizing base image"
      optional: true

"üê≥ dockerizing base image":
  <<: *default-dockerize
  extends: ".dockerize-nocode/data-etat-python-base"
  stage: üê≥ dockerize
  needs: [] # la Dockerization ne d√©pend de rien. On peut faire tourner le job en //